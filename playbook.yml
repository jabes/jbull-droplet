---
- hosts: all

  become: yes
  become_user: root

  tasks:

    - name: Install php repository
      apt_repository:
        repo: ppa:ondrej/php
        state: present

    - name: Install mysql repository
      apt_repository:
        repo: ppa:ondrej/mysql-5.6
        state: present

    - name: Remove existing php packages
      apt:
        name: php*
        state: absent
        purge: true

    - name: Remove existing mysql packages
      apt:
        name: mysql*
        state: absent
        purge: true

    - name: Install apt packages
      apt:
        name: '{{ item }}'
        update_cache: yes
        state: latest
      with_items:
        - apache2
        - libapache2-mod-php5.6
        - php5.6-common
        - php5.6-curl
        - php5.6-json
        - php5.6-mbstring
        - php5.6-mcrypt
        - php5.6-memcache
        - php5.6-mysql
        - mysql-server-5.6
        - python-mysqldb # used by ansible mysql_db module

    - name: Enable php modules
      shell: 'phpenmod {{ item }}'
      with_items:
        - mcrypt
        - memcache

    - name: Enable apache modules
      apache2_module:
        name: '{{ item }}'
        state: present
      with_items:
        - rewrite
      notify: restart apache

    - name: Clone jbull.ca
      git:
        clone: yes
        repo: https://github.com/jabes/website-2012
        dest: /var/www/jbull.ca
        force: yes

    - name: Clone pinup.jbull.ca
      git:
        clone: yes
        repo: https://github.com/jabes/pinup
        dest: /var/www/pinup.jbull.ca
        force: yes

    - name: Clone reports.jbull.ca
      git:
        clone: yes
        repo: https://github.com/jabes/pinup-reports
        dest: /var/www/reports.jbull.ca
        force: yes

    - name: Remove all apache sites
      file:
        state: absent
        path: '{{ item }}'
      with_items:
        - /etc/apache2/sites-available/*
        - /etc/apache2/sites-enabled/*

    - name: Add jbull.ca vhosts configuration
      template:
        src: vhosts.conf.j2
        dest: /etc/apache2/sites-available/jbull.ca.conf
        owner: root
        group: root
        mode: 0644
      vars:
        server_name: jbull.ca
        server_alias: www.jbull.ca
        document_root: /var/www/jbull.ca

    - name: Add pinup.jbull.ca vhosts configuration
      template:
        src: vhosts.conf.j2
        dest: /etc/apache2/sites-available/pinup.jbull.ca.conf
        owner: root
        group: root
        mode: 0644
      vars:
        server_name: pinup.jbull.ca
        document_root: /var/www/pinup.jbull.ca

    - name: Add reports.jbull.ca vhosts configuration
      template:
        src: vhosts.conf.j2
        dest: /etc/apache2/sites-available/reports.jbull.ca.conf
        owner: root
        group: root
        mode: 0644
      vars:
        server_name: reports.jbull.ca
        document_root: /var/www/reports.jbull.ca

    - name: Enable jbull.ca vhost
      command: a2ensite jbull.ca.conf
      notify: restart apache

    - name: Enable pinup.jbull.ca vhost
      command: a2ensite pinup.jbull.ca.conf
      notify: restart apache

    - name: Enable reports.jbull.ca vhost
      command: a2ensite reports.jbull.ca.conf
      notify: restart apache

    - name: Replace localhost domains with production domains for pinup
      replace:
        dest: '{{ item }}'
        regexp: '^(.*)?pinup\.dev(.*)?$'
        replace: '\1pinup.jbull.ca\2'
      with_items:
        - /var/www/pinup.jbull.ca/build/js/prefs.js
        - /var/www/pinup.jbull.ca/cdn/frontend-js/pinup.js
        - /var/www/pinup.jbull.ca/cdn/frontend-js/pinup.min.js
        - /var/www/pinup.jbull.ca/gateway/php/config.php
        - /var/www/pinup.jbull.ca/sql/seed.sql

    - name: Ensure MySQL root user is present
      mysql_user:
        host: 127.0.0.1
        name: root
        password: root
        priv: '*.*:ALL,GRANT'
        login_user: root
        login_password: root
        state: present

    - name: Create pinup database
      mysql_db:
        name: pinup
        login_user: root
        login_password: root
        state: present

    - name: Import pinup .sql files
      mysql_db:
        name: pinup
        login_user: root
        login_password: root
        state: import
        target: '/var/www/pinup.jbull.ca/sql/{{ item }}.sql'
      with_items:
        - schema
        - seed

  handlers:
    - name: restart apache
      service:
        name: apache2
        state: restarted
